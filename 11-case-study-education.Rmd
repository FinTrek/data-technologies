---
knit: bookdown::preview_chapter
---

# PISA

Data can be downloaded from [http://www.oecd.org/pisa/pisaproducts/](http://www.oecd.org/pisa/pisaproducts/database-cbapisa2012.htm)

This example uses a data set with a lot of categorical variables, in addition to numerical variables and it relates to countries that can be displayed as maps.


```{r cache=FALSE, echo = FALSE, message = FALSE, warning = FALSE, results='hide'}
library(dplyr)
library(stringr)
library(reshape2)
library(ggplot2)
library(lubridate)
library(rworldmap)
library(grid)    
library(scales)
library(gridExtra)
library(SAScii)
```

```{r load_data, echo = FALSE, message = FALSE, warning = FALSE, results='hide', cache=FALSE}
#student2012.codebook <- read.table("data/PISA2012/codebook2.txt")
#ptm <- proc.time()
#student2012 <- read.fwf("data/PISA2012/CBA_STU12_MAR31.txt",
#      widths =  student2012.codebook[,2], col.names = student2012.codebook[,1], n=10) 
student2012 <- read.SAScii("data/PISA2012/CBA_STU12_MAR31.txt", "data/PISA2012/PISA2012_SAS_CBA_student.sas",
                           beginline=8997)
#proc.time() - ptm
#student2012.sub <- student2012 %>% select(CNT, SCHOOLID, ST04Q01, ST06Q01, ST57Q01, 
#                                          ST57Q02, ST57Q03, ST57Q04, ST57Q05, ST57Q06, 
#                                          ST11Q01, ST11Q02,
#                                          ST15Q01, ST19Q01,
#                                          ST26Q01, ST26Q02, ST26Q03, ST26Q04, ST26Q05, ST26Q06, ST26Q07, 
#                                          ST26Q08, ST26Q09, ST26Q10, ST26Q11, ST26Q12, ST26Q13, ST26Q14, 
#                                          ST27Q01, ST27Q02, ST27Q03, ST27Q04, ST27Q05, ST28Q01,
#                                          PV1MATH, PV2MATH, PV3MATH, PV4MATH, PV5MATH, 
#                                          PV1READ, PV2READ, PV3READ, PV4READ, PV5READ, 
#                                          PV1SCIE, PV2SCIE, PV3SCIE, PV4SCIE, PV5SCIE, SENWGT_STU)
#saveRDS(student2012.sub, "data/PISA2012/student_sub.rds")
#saveRDS(student2012, "data/PISA2012/student.rds")

student2012.sub <- readRDS("data/PISA2012/student_sub.rds")
```

```{r mapdata, echo = FALSE, message = FALSE, warning = FALSE, results='hide', cache=FALSE}
world <- getMap(resolution = "low")
extractPolys <- function(p) {
  polys <- NULL
  for (i in 1:length(p)) {
    for (j in 1:length(p[[i]]@Polygons)) {
      x <- p[[i]]@Polygons[[j]]@coords
      polys$lon <- c(polys$lon, x[,1])
      polys$lat <- c(polys$lat, x[,2])
      polys$ID <- c(polys$ID, rep(p[[i]]@ID, nrow(x)))
      polys$region <- c(polys$region, rep(paste(p[[i]]@ID, j, sep="_"), nrow(x)))
      polys$order <- c(polys$order, 1:nrow(x))
    }
  }
  return(data.frame(polys))
}
polys <- extractPolys(world@polygons)

# Map theme
theme_map <- theme_bw()
theme_map$line <- element_blank()
theme_map$strip.text <- element_blank()
theme_map$axis.text <- element_blank()
theme_map$plot.title <- element_blank()
theme_map$axis.title <- element_blank()
theme_map$panel.border <- element_rect(colour = "grey90", size=1, fill=NA)
```

```{r dataprep, cache=FALSE, echo = FALSE, message = FALSE, warning = FALSE}
fix_country = function(df) {
  df$CNT = as.character(df$CNT)
  df$CNT[df$CNT=="Serbia"] <- "Republic of Serbia"
  df$CNT[df$CNT=="Korea"] <- "South Korea"
  df$CNT[df$CNT=="Chinese Taipei"] <- "Taiwan"
  df$CNT[df$CNT=="Slovak Republic"] <- "Slovakia"
  df$CNT[df$CNT=="Russian Federation"] <- "Russia"
  df$CNT[df$CNT=="Perm(Russian Federation)"] <- "Russia"
  df$CNT[df$CNT=="Hong Kong-China"] <- "Hong Kong S.A.R."
  df$CNT[df$CNT=="China-Shanghai"] <- "China"
  df$CNT[df$CNT=="China-Macau"] <- "China"
  df$CNT[df$CNT=="Connecticut (USA)"] <- "United States of America"
  df$CNT[df$CNT=="Florida (USA)"] <- "United States of America"
  df$CNT[df$CNT=="Massachusetts (USA)"] <- "United States of America"

  df
}

shorten_countrynames = function(df) {
  df$CNT = as.character(df$CNT)
  df$CNT[df$CNT=="Hong Kong S.A.R."] <- "Hong Kong"
  df$CNT[df$CNT=="Republic of Serbia"] <- "Serbia"
  df$CNT[df$CNT=="United Arab Emirates"] <- "UAE"
  df$CNT[df$CNT=="United States of America"] <- "USA"
  df$CNT[df$CNT=="United Kingdom"] <- "UK"

  df
}

#student2012$ST06Q01 <- as.numeric(student2012$ST06Q01)
#student2012$PV1MATH <- as.numeric(student2012$PV1MATH)
#student2012$PV1READ <- as.numeric(student2012$PV1READ)
#student2012$PV1SCIE <- as.numeric(student2012$PV1SCIE)
#student2012$SENWGT_STU <- as.numeric(student2012$SENWGT_STU)
student2012.sub = fix_country(student2012.sub)
student2012.sub = shorten_countrynames(student2012.sub)
```

```{r computemean, cache=FALSE, echo = FALSE, message = FALSE, warning = FALSE}
student2012.stats <- student2012.sub %>% 
  group_by(CNT) %>%
  summarise(mathgap=mean(PV1MATH[ST04Q01=="Male"], na.rm=T)-
                    mean(PV1MATH[ST04Q01=="Female"], na.rm=T),
            wmathgap=weighted.mean(PV1MATH[ST04Q01=="Male"], 
                                   w=SENWGT_STU[ST04Q01=="Male"], na.rm=T)-
                     weighted.mean(PV1MATH[ST04Q01=="Female"],
                                   w=SENWGT_STU[ST04Q01=="Female"], na.rm=T),
            mtest.stat = t.test(PV1MATH[ST04Q01=="Male"],
                                PV1MATH[ST04Q01=="Female"])$statistic, 
            mp.value = t.test(PV1MATH[ST04Q01=="Male"],
                              PV1MATH[ST04Q01=="Female"])$p.value,
            readgap=mean(PV1READ[ST04Q01=="Male"], na.rm=T) -
                    mean(PV1READ[ST04Q01=="Female"], na.rm=T),
            rtest.stat = t.test(PV1READ[ST04Q01=="Male"],
                                PV1READ[ST04Q01=="Female"])$statistic, 
            rp.value = t.test(PV1READ[ST04Q01=="Male"], 
                              PV1READ[ST04Q01=="Female"])$p.value,
            sciencegap=mean(PV1SCIE[ST04Q01=="Male"], na.rm=T) -
                  mean(PV1SCIE[ST04Q01=="Female"], na.rm=T),
            stest.stat = t.test(PV1SCIE[ST04Q01=="Male"],
                                PV1SCIE[ST04Q01=="Female"])$statistic, 
            sp.value = t.test(PV1SCIE[ST04Q01=="Male"],
                              PV1SCIE[ST04Q01=="Female"])$p.value,         
            minmale = min(PV1MATH[ST04Q01=="Male"], na.rm=T), 
            minfemale = min(PV1MATH[ST04Q01=="Female"], na.rm=T), 
            maxmale = max(PV1MATH[ST04Q01=="Male"], na.rm=T), 
            maxfemale = max(PV1MATH[ST04Q01=="Female"], na.rm=T), 
            propmale = length(PV1MATH[ST04Q01=="Male"])/length(PV1MATH), 
            propfemale = length(PV1MATH[ST04Q01=="Female"])/length(PV1MATH))
student2012.stats$msig <- ifelse(student2012.stats$mp.value>0.05, "none", TRUE)
student2012.stats$msig[student2012.stats$msig==TRUE&student2012.stats$mtest.stat>0] <- "male"
student2012.stats$msig[student2012.stats$msig==TRUE&student2012.stats$mtest.stat<0] <- "female"
#ddply(student2012.sub, .(name), bootfn)
#results <- boot(data=aus, statistic=cifn, R=1000)
student2012.stats$CNT <- factor(student2012.stats$CNT, 
      levels=student2012.stats$CNT[order(student2012.stats$mathgap)])
ggplot(data=student2012.stats) + 
  geom_hline(yintercept=0, colour="grey80") + coord_flip() + theme_bw() + 
  geom_point(aes(x=CNT, y=mathgap, color=msig), size=1) + 
  xlab("") +  
  scale_colour_manual("Significant", values=c("male"="skyblue", "female"="pink", "none"="lightgreen")) +
  scale_y_continuous("Girls <----------> Boys", breaks=seq(-40, 40, 10), limits=c(-45, 45), 
                     labels=c(seq(40, 0, -10), seq(10, 40, 10))) + 
  theme(axis.text.x = element_text(size=5), axis.text.y = element_text(size=5), 
        axis.title = element_text(size=7), legend.text = element_text(size=5),
        legend.title = element_text(size=5))
```

```
student2012.stats$CNT <- as.character(student2012.stats$CNT)
student2012.sub.map <- left_join(student2012.stats, world.polys)
student2012.sub.map$msig <- factor(student2012.sub.map$msig)
ggplot(data=world.polys) + 
  geom_path(aes(x=X1, y=X2, order=order, group=group), colour=I("grey90"), size=0.1) + 
  geom_polygon(data=student2012.sub.map, aes(x=X1, y=X2, order=order, group=group, fill=msig)) +
  scale_fill_manual("Significant", values=c("male"="skyblue", "female"="pink", "none"="lightgreen")) +
  new_theme_empty + theme(legend.position="none", panel.background=element_rect(color="grey50"))
```

